---
# tasks file for notre-dame-nexus-dashboard

- name: Checkout the repository
  git:
    repo: "{{ nexus_dashboard_reposority }}"
    dest: "{{ nexus_dashboard_app_dest }}"
    accept_hostkey: yes
  become: false

- name: Create required directories in opt
  file:
    path: /opt/notredame/apps/ecosystem
    state: directory
    mode: 0755
  become: true

- name: Change directory ownership
  file:
    path: /opt/notredame/apps
    owner: ubuntu
    group: ubuntu
    mode: 0755

- name: Create ecosystem.yml file
  template:
    src: ecosystem.yml.j2
    dest: /opt/notredame/apps/ecosystem/ecosystem.yml

- name: Install the gpg key for nodejs LTS
  apt_key:
    url: "https://deb.nodesource.com/gpgkey/nodesource.gpg.key"
    state: present

- name: Install the nodejs LTS repos
  apt_repository:
    repo: "deb https://deb.nodesource.com/node_8.x xenial main"
    state: present
    update_cache: yes

- name: Install nodejs
  apt:
    name: nodejs
    update_cache: yes

- name: Run npm install
  command: npm install
  args:
    chdir: "{{ nexus_dashboard_app_dest }}"
  become: false

- name: Run build dist
  command: npm run build:dist
  args:
    chdir: "{{ nexus_dashboard_app_dest }}"

- name: Move to opt directory
  command: mv "{{ nexus_dashboard_app_dest }}" /opt/notredame/apps/.

- name: Update staging.js config file
  template:
    src: staging.js.j2
    dest: "{{ nexus_dashboard_staging_loc }}"
    force: yes

- name: Start pm2 service
  command: pm2 start ecosystem.yml --update-env
  args:
    chdir: "{{ nexus_dashboard_ecosystem_loc }}"

